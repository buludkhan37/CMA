<div class="client-list-container">
    <div class="toolbar">
        <div class="search-section">
            <div class="search-box">
                <input
                    type="text"
                    placeholder="Поиск клиентов..."
                    class="search-input"
                    [ngModel]="searchTerm()"
                    (ngModelChange)="searchTerm.set($event)"
                    (input)="onSearch()"
                />
                <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    class="search-icon"
                >
                    <circle cx="11" cy="11" r="8" />
                    <path d="m21 21-4.35-4.35" />
                </svg>
            </div>
        </div>

        <div class="actions-section">
            <button
                title="Обновить список"
                class="btn btn-secondary"
                [disabled]="isLoading()"
                (click)="refreshClients()"
            >
                <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                >
                    <path
                        d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"
                    />
                </svg>
                Обновить
            </button>
            @if (selectedClients().length > 0) {
                <span class="selected-count">Выбрано: {{ selectedClients().length }}</span>
            }
            <button
                class="btn btn-primary"
                [disabled]="selectedClients().length === 0"
                (click)="openPushModal()"
            >
                <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                >
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                    <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                </svg>
                Отправить Push
            </button>
        </div>
    </div>

    @if (isLoading()) {
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Загрузка клиентов...</p>
        </div>
    } @else {
        <div class="table-container">
            <table class="client-table">
                <thead>
                    <tr>
                        <th class="checkbox-column">
                            <input
                                type="checkbox"
                                class="checkbox"
                                [checked]="isAllSelected()"
                                [indeterminate]="isIndeterminate()"
                                (change)="selectAllClients()"
                            />
                        </th>
                        @for (column of columns; track column) {
                            <th [class.sortable]="column.sortable" (click)="sortBy(column.key)">
                                {{ column.label }}
                                @if (column.sortable) {
                                    <span class="sort-icon">
                                        {{ getSortIcon(column.key) }}
                                    </span>
                                }
                            </th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @for (client of filteredClients(); track client.id) {
                        <tr class="client-row" [class.selected]="isClientSelected(client)">
                            <td class="checkbox-column">
                                <input
                                    type="checkbox"
                                    class="checkbox"
                                    [checked]="isClientSelected(client)"
                                    (change)="toggleClientSelection(client)"
                                />
                            </td>
                            <td class="name-column">
                                <div class="client-name">
                                    <svg
                                        width="16"
                                        height="16"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        class="user-icon"
                                    >
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                        <circle cx="12" cy="7" r="4" />
                                    </svg>
                                    {{ client.name }}
                                </div>
                            </td>
                            <td class="email-column">{{ client.email || '-' }}</td>
                            <td class="phone-column">{{ client.phone || '-' }}</td>
                            <td class="company-column">{{ client.company || '-' }}</td>
                            <td class="status-column">
                                <span
                                    class="status-badge"
                                    [ngClass]="getStatusClass(client.status)"
                                >
                                    {{ getStatusLabel(client.status) }}
                                </span>
                            </td>
                            <td class="date-column">{{ formatDate(client.created_at) }}</td>
                        </tr>
                    }
                </tbody>
            </table>

            @if (filteredClients().length === 0 && !isLoading()) {
                <div class="empty-state">
                    <svg
                        width="64"
                        height="64"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1"
                    >
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                        <circle cx="8.5" cy="7" r="4" />
                        <path d="m15 14 4 4" />
                        <path d="M19 14v4h-4" />
                    </svg>
                    <h3>Клиенты не найдены</h3>
                    <p>По вашему запросу "{{ searchTerm() }}" клиентов не найдено</p>
                </div>
            }
        </div>
    }
    @if (!isLoading() && filteredClients().length > 0) {
        <div class="results-summary">
            Показано {{ filteredClients().length }} из {{ clients().length }} клиентов
        </div>
    }
</div>

@if (showPushModal()) {
    <app-push-modal
        [selectedClients]="selectedClients()"
        (close)="closePushModal()"
        (pushSent)="onPushSent()"
    ></app-push-modal>
}
